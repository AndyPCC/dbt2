#!/bin/sh
#
# This file is released under the terms of the Artistic License.
# Please see the file LICENSE, included in this package, for details.
#
# Copyright (C) 2006      Open Source Development Labs, Inc.
#               2006-2014 Mark Wong
#               2014      2ndQuadrant, Ltd.
#

error() {
	echo "ERROR: $@"
	exit 1
}

warning() {
	echo "WARNING: $@"
}

while getopts "b:i:o:" opt; do
	case $opt in
	b)
		BLKDEVICES=${OPTARG}
		;;
	i)
		INDIR=${OPTARG}
        MIXLOG=${INDIR}/mix.log
		;;
	o)
		OUTDIR=${OPTARG}
		;;
	esac
done

if [ "x$OUTDIR" = "x" ]; then
	OUTDIR=$INDIR
fi

DBMS=`grep RDBMS $INDIR/readme.txt | cut -d " " -f 2`
if [ "x$DBMS" = "x" ]; then
	error "Could not determine what RDBMS used from results"
fi

DBNAME=`grep "Database Name" $INDIR/readme.txt | cut -d " " -f 3`
if [ "x$DBNAME" = "x" ]; then
	warning "Could not determine what the database name used from results"
fi

echo "Generating transaction distribution charts..."
mkdir -p ${OUTDIR}/txn || exit 1
dbt-plot-transaction-distribution Delivery d ${MIXLOG} ${OUTDIR}/txn 1 \
		|| warning "Could not create Delivery response time distribution char"
dbt-plot-transaction-distribution "New Order" n ${MIXLOG} ${OUTDIR}/txn 2 \
		|| warning "Could not create New Order response time distribution char"
dbt-plot-transaction-distribution "Order Status" o ${MIXLOG} ${OUTDIR}/txn 3 \
		|| warning "Could not create Order Status response time distribution char"
dbt-plot-transaction-distribution "Payments" p ${MIXLOG} ${OUTDIR}/txn 4 \
		|| warning "Could not create Payments response time distribution char"
dbt-plot-transaction-distribution "Stock Level" s ${MIXLOG} ${OUTDIR}/txn 5 \
		|| warning "Could not create Stock Level response time distribution char"

mkdir -p ${OUTDIR}/db/sar || exit 1

echo "Generating sar io charts..."
SARBLOCKDEVFILE="${INDIR}/db/sar-blockdev.csv"
if [ -f "${SARBLOCKDEVFILE}" ]; then
	dbt-plot-sar-blockdev ${SARBLOCKDEVFILE} ${OUTDIR}/db/sar ${BLKDEVICES} \
			|| warning "Could not create sar blockdev charts"
fi

echo "Generating processor utilization charts..."
SARCPUFILE="${INDIR}/db/sar-cpu.csv"
if [ -f "${SARCPUFILE}" ]; then
	dbt-plot-sar-cpu ${SARCPUFILE} ${OUTDIR}/db/sar \
			|| warning "Could not create sar cpu charts"
fi

echo "Generating transaction rate charts..."
dbt2-plot-transaction-rate ${MIXLOG} ${OUTDIR}/txn \
		|| warning "Could not create transaction rate charts"

echo "Generating database statistics charts..."
if [ "${DBMS}" = "pgsql" ]; then
	export PGDATABASE=$DBNAME
	TABLEDIR=$OUTDIR/db/table
	INDEXDIR=$OUTDIR/db/indexes

	mkdir -p $TABLEDIR || exit 1
	mkdir -p $INDEXDIR || exit 1

	dbt-pgsql-plot-database-stats ${INDIR}/db/pg_stat_databases.csv $DBNAME \
			$OUTDIR/db || warning "Could not create database stats charts"
	for TABLENAME in `cat ${INDIR}/db/table-list.txt`; do
		dbt-pgsql-plot-table-stats ${INDIR}/db/pg_stat_tables.csv \
				$TABLENAME $TABLEDIR \
				> $TABLEDIR/r.log 2>&1 \
				|| warning "Could not create table stats charts for $TABLENAME"
	done
	for INDEXNAME in `cat ${INDIR}/db/index-list.txt`; do
		dbt-pgsql-plot-index-stats $INDIR/db/pg_stat_indexes.csv \
				$INDEXNAME $INDEXDIR > $INDEXDIR/r.log 2>&1 \
				|| warning "Could not create index stats charts for $INDEXNAME"
	done
elif [ "${DBMS}" = "mysql" ]; then
	warning "Charting for MySQL database statistics not implementd"
elif [ "${DMBS}" = "drizzle" ]; then
	warning "Charting for Drizzle database statistics not implementd"
elif [ "${DBMS}" = "sqlite" ]; then
	warning "Charting for SQLite database statistics not implementd"
else
	error "unrecognized dbms"
fi

DMIX=`grep Delivery ${INDIR}/report.txt | awk -F " " '{print $2}'`
DAVG=`grep Delivery ${INDIR}/report.txt | awk -F " " '{print $3}'`
D90P=`grep Delivery ${INDIR}/report.txt | awk -F " " '{print $5}'`
DTOT=`grep Delivery ${INDIR}/report.txt | awk -F " " '{print $6}'`
DROL=`grep Delivery ${INDIR}/report.txt | awk -F " " '{print $7}'`
DRPE=`grep Delivery ${INDIR}/report.txt | awk -F " " '{print $8}'`

NMIX=`grep "New Order" ${INDIR}/report.txt | awk -F " " '{print $3}'`
NAVG=`grep "New Order" ${INDIR}/report.txt | awk -F " " '{print $4}'`
N90P=`grep "New Order" ${INDIR}/report.txt | awk -F " " '{print $6}'`
NTOT=`grep "New Order" ${INDIR}/report.txt | awk -F " " '{print $7}'`
NROL=`grep "New Order" ${INDIR}/report.txt | awk -F " " '{print $8}'`
NRPE=`grep "New Order" ${INDIR}/report.txt | awk -F " " '{print $9}'`

OMIX=`grep "Order Status" ${INDIR}/report.txt | awk -F " " '{print $3}'`
OAVG=`grep "Order Status" ${INDIR}/report.txt | awk -F " " '{print $4}'`
O90P=`grep "Order Status" ${INDIR}/report.txt | awk -F " " '{print $6}'`
OTOT=`grep "Order Status" ${INDIR}/report.txt | awk -F " " '{print $7}'`
OROL=`grep "Order Status" ${INDIR}/report.txt | awk -F " " '{print $8}'`
ORPE=`grep "Order Status" ${INDIR}/report.txt | awk -F " " '{print $9}'`

PMIX=`grep Payment ${INDIR}/report.txt | awk -F " " '{print $2}'`
PAVG=`grep Payment ${INDIR}/report.txt | awk -F " " '{print $3}'`
P90P=`grep Payment ${INDIR}/report.txt | awk -F " " '{print $5}'`
PTOT=`grep Payment ${INDIR}/report.txt | awk -F " " '{print $6}'`
PROL=`grep Payment ${INDIR}/report.txt | awk -F " " '{print $7}'`
PRPE=`grep Payment ${INDIR}/report.txt | awk -F " " '{print $8}'`

SMIX=`grep "Stock Level" ${INDIR}/report.txt | awk -F " " '{print $3}'`
SAVG=`grep "Stock Level" ${INDIR}/report.txt | awk -F " " '{print $4}'`
S90P=`grep "Stock Level" ${INDIR}/report.txt | awk -F " " '{print $6}'`
STOT=`grep "Stock Level" ${INDIR}/report.txt | awk -F " " '{print $7}'`
SROL=`grep "Stock Level" ${INDIR}/report.txt | awk -F " " '{print $8}'`
SRPE=`grep "Stock Level" ${INDIR}/report.txt | awk -F " " '{print $9}'`

OS=`head -n 1 ${INDIR}/db/readme.txt | cut -d " " -f 1`
OSVER=`head -n 1 ${INDIR}/db/readme.txt | cut -d " " -f 3`
ARCH=`head -n 1 ${INDIR}/db/readme.txt | cut -d " " -f 12`
DBVER=`head -n 2 ${INDIR}/db/readme.txt | tail -n 1`

if [ -d "${OUTDIR}/driver" ]; then
	DRIVER_CHART_LINK="\
<tr>\
<td align="right">Driver Charts:</td>\
<td><a href="driver">View Directories</a></td>\
</tr>\
"
fi

cat > ${OUTDIR}/index.html << __EOF__
<html>
<head>
<title>Database Test 2 Report</title>
</head>
<body>
<h1>Database Test 2 Report</h1>

<p>
`head -n 1 ${INDIR}/readme.txt`
</p>

<table>

<tr>
<td>
<table>
<caption>Results Summary</caption>

<tr>
<td align="right">New Order Transactions per Minute (notpm):</td>
<td>`grep NOTPM ${INDIR}/report.txt | cut -d " " -f 1`</td>
</tr>

<tr>
<td align="right">Scale Factor:</td>
<td>`grep "Database Scale Factor" ${INDIR}/readme.txt | cut -d " " -f 4`</td>
</tr>

<tr>
<td align="right">Test Duration (min):</td>
<td>`grep Duration ${INDIR}/readme.txt | cut -d " " -f 3`</td>

</tr>

</table>
</td>
<td>
  <a href="txn/n-transaction-rate.png">
    <img width="128" src="txn/n-transaction-rate.png" height="96" />
  </a>
</td>
</tr>

</table>

<table border="1">
<caption>Transaction Summary</caption>

<tr>
<th colspan="3">Transaction</th>
<th colspan="2">Response Time (seconds)</th>
<th colspan="2">Rollbacks</th>
<th colspan="2">Charts</th>
</tr>

<tr>
<th>Name</th>
<th>Mix %</th>
<th>Total</th>
<th>Average (s)</th>
<th>90th %</th>
<th>Total</th>
<th>%</th>
<th>Response Time</th>
<th>Time Distribution</th>
</tr>

<tr>
<td>Delivery</td>
<td align="right">${DMIX}</td>
<td align="right">${DTOT}</td>
<td align="right">${DAVG}</td>
<td align="right">${D90P}</td>
<td align="right">${DROL}</td>
<td align="right">${DRPE}</td>
<td align="center">
  <a href="txn/d-transaction-rate.png">
    <img width="128" src="txn/d-transaction-rate.png" height="96" />
  </a>
</td>
<td align="center">
  <a href="txn/td-distribution.png">
    <img width="128" src="txn/td-distribution.png" height="96" />
  </a>
</td>
</tr>

<tr>
<td>New Order</td>
<td align="right">${NMIX}</td>
<td align="right">${NTOT}</td>
<td align="right">${NAVG}</td>
<td align="right">${N90P}</td>
<td align="right">${NROL}</td>
<td align="right">${NRPE}</td>
<td align="center">
  <a href="txn/n-transaction-rate.png">
    <img width="128" src="txn/n-transaction-rate.png" height="96" />
  </a>
</td>
<td align="center">
  <a href="txn/tn-distribution.png">
    <img width="128" src="txn/tn-distribution.png" height="96" />
  </a>
</td>
</tr>

<tr>
<td>Order Status</td>
<td align="right">${OMIX}</td>
<td align="right">${OTOT}</td>
<td align="right">${OAVG}</td>
<td align="right">${O90P}</td>
<td align="right">${OROL}</td>
<td align="right">${ORPE}</td>
<td align="center">
  <a href="txn/o-transaction-rate.png">
    <img width="128" src="txn/o-transaction-rate.png" height="96" />
  </a>
</td>
<td align="center">
  <a href="txn/to-distribution.png">
    <img width="128" src="txn/to-distribution.png" height="96" />
  </a>
</td>
</tr>

<tr>
<td>Payment</td>
<td align="right">${PMIX}</td>
<td align="right">${PTOT}</td>
<td align="right">${PAVG}</td>
<td align="right">${P90P}</td>
<td align="right">${PROL}</td>
<td align="right">${PRPE}</td>
<td align="center">
  <a href="txn/p-transaction-rate.png">
    <img width="128" src="txn/p-transaction-rate.png" height="96" />
  </a>
</td>
<td align="center">
  <a href="txn/tp-distribution.png">
    <img width="128" src="txn/tp-distribution.png" height="96" />
  </a>
</td>
</tr>

<tr>
<td>Stock Level</td>
<td align="right">${SMIX}</td>
<td align="right">${STOT}</td>
<td align="right">${SAVG}</td>
<td align="right">${S90P}</td>
<td align="right">${SROL}</td>
<td align="right">${SRPE}</td>
<td align="center">
  <a href="txn/s-transaction-rate.png">
    <img width="128" src="txn/s-transaction-rate.png" height="96" />
  </a>
</td>
<td align="center">
  <a href="txn/ts-distribution.png">
    <img width="128" src="txn/ts-distribution.png" height="96" />
  </a>
</td>
</tr>

</table>

<table>
<caption>System Summary</caption>

<tr>
<td align="right">Operating System:</td>
<td>${OS} ${ARCH} ${OSVER}</td>
<td><a href="proc.txt">Settings</a></td>
</tr>

<tr>
<td align="right">Database Management System:</td>
<td>${DBVER}</td>
<td><a href="db/plan0.txt">Query Plans</a></td>
</tr>

<tr>
<td align="right">Notes:</td>
<td>`head -n 1 ${INDIR}/readme.txt`</td>
</tr>
${DRIVER_CHART_LINK}
<tr>
<td align="right">Database Charts:</td>
<td><a href="db">View Directories</a></td>
</tr>

</table>

</body>
</html>
__EOF__

#!/bin/bash
#
# This file is released under the terms of the Artistic License.
# Please see the file LICENSE, included in this package, for details.
#
# Copyright (C) 2002-2008 Mark Wong & Open Source Development Labs, Inc.
#

TOPDIR="@abs_top_srcdir@"
export DATABASE="pgsql"
source ${TOPDIR}/bin/dbt2_profile || exit 1

DIR=`dirname $0`

while getopts "l:p:" OPT; do
	case ${OPT} in
	l)
		PORT=${OPTARG}
		;;
	p)
		PARAMETERS=${OPTARG}
		;;
	esac
done

# Create database
echo "Creating database..."
if [ -d ${PGDATA} ]; then
	echo "======================================="
	echo "PGData directory ${PGDATA} already exists"
	echo "Skipping initdb"
	echo "======================================="
else
	${INITDB} -D ${PGDATA} --locale=C || exit 1
	cp -p ${DIR}/pg_hba.conf ${PGDATA}/ || exit 1
fi

${DIR}/dbt2-pgsql-start-db -p "${PARAMETERS}" || exit 1

# Give the database a few seconds to get going
sleep 4

${CREATEDB} -p ${PORT} ${DBNAME} || exit 1
${CREATELANG} -p ${PORT} plpgsql ${DBNAME}

exit 0
